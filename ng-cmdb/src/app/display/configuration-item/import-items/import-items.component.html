<app-busy *ngIf="busy" i18n="analyzing">Analysiere...</app-busy>
<div class="box">
    <div class="box-top">
        <h3 i18n="import configuration items">Configuration Items importieren</h3>
    </div>
    <form [formGroup]="form" (submit)="onSubmit()" class="box-body">
        <div *ngIf="!fileContent">
            <div class="box-top__sub" i18n="common settings">Allgemeine Einstellungen</div>
            <div class="box-body__sub">
                <div>
                    <mat-form-field>
                        <mat-label i18n="item type to import">Typ der zu importierenden Items</mat-label>
                        <mat-select name="type" formControlName="itemType"
                            (selectionChange)="onChangeItemType($event.value)">
                            <mat-option *ngFor="let itemType of (itemTypes | async)" [value]="itemType.TypeId"
                                [style.background]="itemType.TypeBackColor">
                                <span class="text-on-background">{{itemType.TypeName}}</span>
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div>
                    <mat-form-field>
                        <mat-label i18n="additional elements to import">Welche weiteren Elemente sollen importiert werden?</mat-label>
                        <mat-select matInput name="elements" formControlName="elements" multiple
                            (selectionChange)="onChangeElements($event.value)">
                            <mat-option value="attributes" i18n="attributes">Attribute</mat-option>
                            <mat-option value="connToLower" i18n="connections to lower">Verbindungen nach unten</mat-option>
                            <mat-option value="connToUpper" i18n="connections to upper">Verbindungen nach oben</mat-option>
                            <mat-option value="links" i18n="hyperlinks">Hyperlinks</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
                <div class="margin">
                    <mat-slide-toggle formControlName="ignoreExisting"
                        i18n="ignore item names that already exist"
                        i18n-matTooltip="only CIs are created, if the name does not exist. if it does, nothing will be changed"
                        matTooltip="Es werden nur neue CIs angelegt, vorhanden werden nicht ver&auml;ndert, wenn diese Option gew&auml;hlt ist.">
                        CIs, deren Namen bereits vorhanden ist, sollen ignoriert werden.
                    </mat-slide-toggle>
                </div>
                <div class="margin">
                    <mat-slide-toggle formControlName="headlines"
                        i18n="the first line of the file contains column headers"
                        i18n-matTooltip="the column headers will be compared with the name of the elements (e. g. attributes and connections) for a quicker re-import of an exported file"
                        matTooltip="Die Spalten&uuml;berschriften werden mit den Namen der Elemente (z. B. Attribute und Verbindungen) verglichen und bei &Uuml;bereinstimmung zugeordnet. So kann eine exportierte Datei schnell wieder importiert werden.">
                        Die erste Zeile der Datei enth&auml;lt die Spalten&uuml;berschriften.
                    </mat-slide-toggle>
                </div>
                <div class="margin" *ngIf="form.get('itemType').valid">
                    <input class="inputfile" type="file" id="file" #file formControlName="file"
                        (change)="handleFileInput($event.target.files)">
                    <label class="mat-button" for="file" i18n="choose file">
                        Datei ausw&auml;hlen
                        <div class="mat-button-focus-overlay"></div>
                    </label>
                </div>
            </div>
        </div>
        <div *ngIf="fileContent">
            <div class="box-top__sub" i18n="item type">Item-Typ</div>
            <div class="box-body__sub">{{(selectedItemType | async).TypeName}}</div>
        </div>
        <div *ngIf="fileContent && !dataTable">
            <div class="box-top__sub" i18n="column mappings">Spaltenzuordnungen</div>
            <div class="box-body__sub" formArrayName="columns">
                <div *ngFor="let name of columnNames; let i = index">
                    <mat-form-field>
                        <mat-label>({{i}}) {{name}}</mat-label>
                        <select matNativeControl [formControlName]="i">
                            <option *ngFor="let keyvalue of (targetColumns | async)" [value]="keyvalue.key">
                                {{keyvalue.value}}
                            </option>
                        </select>
                    </mat-form-field>
                </div>
                <div>
                    <button mat-button type="button" i18n="back" (click)="onBackToFirst()">Zur&uuml;ck</button>
                    <button mat-button type="button" i18n="continue" [disabled]="form.invalid"
                        (click)="onContinue()">
                        Weiter
                    </button>
                </div>
            </div>
        </div>
        <div *ngIf="dataTable">
            <ng-container *ngIf="dataTable.rows.length > 0">
                <div class="box-top__sub" i18n="elements that can be imported">
                    Zu importierende Elemente
                </div>
                <div class="box-body__sub">
                    <table mat-table [dataSource]="dataTable.rows" class="mat-elevation-z8">
                        <ng-container *ngFor="let column of dataTable.columns; let i = index">
                            <ng-container [matColumnDef]="column.name">
                                <th mat-header-cell *matHeaderCellDef>
                                    {{column.caption}}
                                </th>
                                <td mat-cell *matCellDef="let line">
                                    {{line[i]}}
                                </td>
                            </ng-container>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                        <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
                    </table>
                </div>
            </ng-container>
            <ng-container *ngIf="errorList.length > 0">
                <div class="box-top__sub" i18n="problems found">
                    Erkannte Probleme
                </div>
                <div class="box-body__sub">
                    <table mat-table [dataSource]="errorList" class="mat-elevation-z8">
                        <ng-container matColumnDef="index">
                            <th mat-header-cell *matHeaderCellDef i18n="line">
                                Zeile
                            </th>
                            <td mat-cell *matCellDef="let entry">
                                {{entry.index + 1}}
                            </td>
                        </ng-container>
                        <ng-container matColumnDef="message">
                            <th mat-header-cell *matHeaderCellDef i18n="error message">
                                Fehlermeldung
                            </th>
                            <td mat-cell *matCellDef="let entry">
                                <ng-container [ngSwitch]="entry.message">
                                    <span *ngSwitchCase="'empty name'" i18n="item name cannot be empty">
                                        Der Name des Item darf nicht leer sein.
                                    </span>
                                    <span *ngSwitchCase="'duplicate line'" i18n="name is used in multiple lines. duplicate line ignored">
                                        Der Name des Items kommt mehrfach vor. Die doppelte Zeile wird ignoriert.
                                    </span>
                                    <span *ngSwitchCase="'existing item ignored'" i18n="existing item ignored">
                                        Ein Item mit diesem Namen existiert bereits. Entsprechend der Einstellung wird die Zeile ignoriert.
                                    </span>
                                </ng-container>
                            </td>
                        </ng-container>
                        <tr mat-header-row *matHeaderRowDef="['index', 'message']"></tr>
                        <tr mat-row *matRowDef="let row; columns: ['index', 'message']"></tr>
                    </table>
                </div>
            </ng-container>
            <div *ngIf="dataTable.rows.length === 0" class="red"
                i18n="There are no lines to import. Please retry with another file or other settings.">
                Es gibt keine Zeilen zum Importieren. Bitte versuchen Sie es mit einer anderen Datei oder anderen Einstellungen.
            </div>
            <button mat-button type="submit" i18n="import items" [disabled]="form.invalid || dataTable.rows.length === 0">
                Items importieren
            </button>
        </div>
    </form>
</div>